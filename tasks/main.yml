---

- name: replace cobbler-s sources.list to mainline
  template:
    src: sources.list.j2
    dest: /etc/apt/sources.list

- name: add ElementaryOS ppa, nvidia ppa, and owncloud official repo
  apt_repository:
    repo: "{{ item }}"
  with_items:
    - 'ppa:elementary-os/stable'
    - 'ppa:elementary-os/os-patches'
    - 'ppa:graphics-drivers/ppa'
    - 'deb http://download.opensuse.org/repositories/isv:/ownCloud:/desktop/Ubuntu_16.04/ /'

- name: Add owncloud apt key
  apt_key:
    url: "http://download.opensuse.org/repositories/isv:ownCloud:desktop/Ubuntu_16.04/Release.key"
    state: present

- name: Upgrade system
  apt:
    upgrade: full
    update_cache: yes

- name: install ElementaryOS
  apt:
    name: "elementary-desktop"
    state: present

- name:  get recommended ubuntu drivers
  shell: "ubuntu-drivers devices | grep recommended | awk '{print $3}'"
  register: recommended_nvidia

- name: install some packages
  apt:
    name: "{{ item }}"
  with_items:
    - 'gconf-service'
    - 'libgconf-2-4'
    - 'software-properties-common'
    - 'skype'
   # temporary commented. No nvidia in the test VM. Uncomment in production!
   # - "{{ recommended_nvidia.stdout }}"
    - 'nvidia-settings'
    - 'xfonts-terminus'
    - "qemu-kvm"
    - "qemu"
    - "virt-manager"
    - "libvirt-bin"
    - "ssh"
    - 'atop'
    - 'htop'
    - 'chromium-browser'
    - 'firefox'
    - 'adobe-flashplugin'
       #steam's suggestion and depency
    - 'xfonts-cyrillic'
    - 'curl'
- name: fix apt-get after install skype i386 packages
  shell: 'apt-get install -fy'

- name: Install owncloud packages
  apt:
    name: 'owncloud-client'
    allow_unauthenticated: yes

- name:  set terminal settings
  shell: "gsettings set org.pantheon.terminal.settings font 'Terminus 36'"

- name: download Skype alfa (works together with old 4.3, useful to have 2 different skype online. Also MS have a plans to disable 4.3)
  get_url:
    url: 'https://go.skype.com/skypeforlinux-64-alpha.deb'
    dest: '/tmp/skypeforlinux-64-alpha.deb'

- name: download latest Steam
  get_url:
    url: 'https://steamcdn-a.akamaihd.net/client/installer/steam.deb'
    dest: '/tmp/steam.deb'

- name: Accept steam's question
  debconf:
    name: 'steam'
    question: 'steam/question'
    value: ' I AGREE'
    vtype: select

- name: Accept steam's license
  debconf:
    name: 'steam'
    question: 'steam/license'
    value: ''
    vtype: note

- name: Install a .deb package of the Skype alfa and Steam
  apt:
    deb: "{{ item }}"
  with_items:
   - '/tmp/skypeforlinux-64-alpha.deb'
   - '/tmp/steam.deb'

- name: Fix cobbler-s settings of network
  template:
    src: interfaces.j2
    dest: /etc/network/interfaces

- name: Clean Ubuntu packages
  apt:
    name: "{{ item }}"
    state: absent
  with_items:
    - 'plymouth-theme-ubuntu-text'
    - 'unity-greeter'
    - 'unity-control-center-signon'

- name: fstab options for root file system
  mount:
    name: /
    src: "UUID={{ item.uuid }}"
    opts: "rw,errors=remount-ro,noatime,discard"
    fstype: "{{ item.fstype }}"
    state: present
  with_items: ansible_mounts
  when: item.mount == "/"

- name: fstab options for home file system
  mount:
    name: /home
    src:  "UUID={{ item.uuid }}"
    opts: "rw,errors=remount-ro,noatime,discard"
    fstype: "{{ item.fstype }}"
    state: present
  with_items: ansible_mounts
  when: item.mount == "/home"